const sqlite3 = require('sqlite3').verbose();
const path = require('path');
const {compile} = require("ejs");
const e = require("express");
module.exports = {
    getCustomerByEmail,
    insertCustomer, getAllBooks,
    getBooksWithAuthors,
    getAuthorByName,
    getBooksByAuthor,
    getCartByCustomer,
    getCustomerById,
    updateCustomer,
    removeFromCart,
    addToCart,
    getAllCustomers,
    editCustomer,
    getBookById,
    editBook,
    getAuthorById,
    getAllAuthors,
    editAuthor,
    removeBook,
    createBook,
    createAuthor,
    removeAuthor,
    removeCustomer,
    createCustomer
};

const dbPath = path.join(__dirname, '..', 'db', 'projectDb.db');
const db = new sqlite3.Database(dbPath);

//========== new customer =========
function insertCustomer(name, lastName, email, password){
    let sql = 'INSERT INTO Customer(Name, LastName, email, password, admin) VALUES (?, ?, ?, ?, 0)';

    console.log("inside script: "+  name + " " + lastName + " " + email + " " + password);

    db.run(sql, name, lastName, email, password, (err, row) =>{
        if(err){
            console.log(err);
            return false;
        }
        return true;
    });

}

//========= create Customer ==========
function createCustomer(Name, LastName, Email, Password, Admin){
    let adminStatus;
    let sql = 'INSERT INTO Customer(Name, LastName, email, password, admin) VALUES (?, ?, ?, ?, ?)';

    if(Admin){
        adminStatus = 1;
    }else{
        adminStatus = 0;
    }

    return new Promise((resolve, reject) => {
        db.run(sql, Name, LastName, Email, Password, adminStatus, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });


}

//=========== get books ===========
//ai generated while debugging
function getAllBooks() {
    let sql = 'SELECT * FROM Book';

    return new Promise((resolve, reject) => {
        db.all(sql, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

//========get books with authors=========
function getBooksWithAuthors() {

    //generated by chat
    let sql = `
        SELECT 
            Book.bookId,
            Book.Title,
            Book.Genre,
            Book.price,
            Book.img,
            Book.author AS authorId,
            Author.authorId AS existingAuthorId,
            Author.authorName AS authorName
        FROM Book
        LEFT JOIN Author ON Book.author = Author.authorId
    `;

    return new Promise((resolve, reject) => {
        db.all(sql, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

//========= get books by author =========

function getBooksByAuthor(name) {
    let sql = 'SELECT * FROM Book, Author WHERE author = authorId AND authorName = ?';

    return new Promise((resolve, reject) => {
        db.all(sql, name, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}
//========== remove book ================
function removeBook(bookId){
    let sql = 'DELETE FROM Book WHERE bookId = ?';

    return new Promise((resolve, reject) => {
        db.all(sql, bookId, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

//=========== create book ==============
function createBook(Title, Genre, Author, Price, Img){
    let sql = 'INSERT INTO Book(Title, Genre, author, price, img) VALUES (?, ?, ?, ?, ?)';

    return new Promise((resolve, reject) => {
        db.all(sql, Title, Genre, Author, Price, Img, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

//=========== get authors ===============
function getAllAuthors(){
    let sql = 'SELECT * FROM Author';

    return new Promise((resolve, reject) => {
        db.all(sql, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}
//======= get author by name =========

function getAuthorByName(name) {
    let sql = 'SELECT * FROM Author WHERE authorName = ?';

    return new Promise((resolve, reject) => {
        db.all(sql, name, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

//========= get author by id =========
function getAuthorById(id){
    let sql = 'SELECT * FROM Author WHERE authorId = ?';

    return new Promise((resolve, reject) => {
        db.get(sql, id, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

//========= edit author ==========
function editAuthor(authorId, authorName, LastName, previousId){
    let sql = 'UPDATE Author SET authorId = ?, authorName = ?, LastName = ? WHERE authorId = ?'

    db.run(sql, authorId, authorName, LastName, previousId, (err, row) =>{
        if(err){
            console.log(err);
            return false;
        }
        return true;
    });
}

//======== create author =========
function createAuthor(authorName, LastName){
    let sql = 'INSERT INTO Author(authorName, LastName) VALUES (?, ?)';

    return new Promise((resolve, reject) => {
        db.all(sql, authorName, LastName, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

//======== remove author =========
function removeAuthor(authorId){
    let sql = 'DELETE FROM Author WHERE authorId = ?';

    return new Promise((resolve, reject) => {
        db.all(sql, authorId, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

//============= CART ===============
//=========== get carts ===========
function getCart(){
    let sql = 'SELECT * FROM CART';

    db.get(sql, (err, row)=>{
        if(err){
            console.log(err);
        }
        return row;
    });
}

//======= get customer's cart ======
function getCartByCustomer(customerId){
    let sql = 'SELECT * FROM CART, Book, Customer, Author WHERE customer = customerId AND book = bookId AND author = authorId AND customerId = ?';

    return new Promise((resolve, reject) => {
        db.all(sql, customerId, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

//====== remove from cart ========
function removeFromCart(cartId, customerId){
    let sql = 'DELETE FROM CART WHERE cartId = ? AND customer = ?'

    return new Promise((resolve, reject) => {
        db.all(sql, cartId, customerId, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

//======== add to cart =========
function addToCart(bookId, customerId){
    let date = new Date;
    date = date.getDate() +"-"+ date.getMonth() +"-"+ date.getFullYear() + " " + date.getHours() + ":" + date.getMinutes();
    let sql = 'INSERT INTO CART(book, customer, additionDate) VALUES (?, ?, "'+ date +'")'

    db.run(sql, bookId, customerId, (err, row) =>{
        if(err){
            console.log(err);
            return false;
        }
        return true;
    });
}

//================book==================
//=========== get book by id ===========
function getBookById(id){
    let sql = 'SELECT * FROM Book WHERE bookId = ?';

    return new Promise((resolve, reject) => {
        db.get(sql, id, (err, row) =>{
            if(err){
                reject(err);
            }else{
                resolve(row);
            }

            return row;
        });
    })

}

//=========== edit book =============
function editBook(id, title, genre, author, price, img, previousId){
    let sql = 'UPDATE Book SET bookId = ?, Title = ?, Genre = ?, author = ?, price = ?, img = ? WHERE bookId = ?';

    db.run(sql, id, title, genre, author, price, img, previousId, (err, row) =>{
        if(err){
            console.log(err);
            return false;
        }
        return true;
    });
}

//================customer==================
//=========== get book by id ===========
async function getCustomerByEmail(email){
    let sql = 'SELECT * FROM Customer WHERE email=?'

    return new Promise((resolve, reject) => {
        db.get(sql, email, (err, row) =>{
            if(err){
                reject(err);
            }else{
                resolve(row);
            }

            return row;
        });
    })
}

//======== get customer by id ========
function getCustomerById(id){
    let sql = 'SELECT * FROM Customer WHERE customerId = ?'

    return new Promise((resolve, reject) => {
        db.get(sql, id, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

//=========== get customers ===========
function getAllCustomers(){
    let sql = 'SELECT * FROM Customer';

    return new Promise((resolve, reject) => {
        db.all(sql, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

//========== update profile =========
function updateCustomer(name, lastName, email, password, userId){
    let sql = 'UPDATE Customer SET Name = ?, LastName = ?, email = ?, password = ? WHERE customerId = ?'

    db.run(sql, name, lastName, email, password, userId, (err, row) =>{
        if(err){
            console.log(err);
            return false;
        }
        return true;
    });
}

//========= edit customer ==========
function editCustomer(id, name, lastName, email, password, userId){
    let sql = 'UPDATE Customer SET customerId = ?, Name = ?, LastName = ?, email = ?, password = ? WHERE customerId = ?'

    db.run(sql, id, name, lastName, email, password, userId, (err, row) =>{
        if(err){
            console.log(err);
            return false;
        }
        return true;
    });
}

//======== remove customer =========
function removeCustomer(customerId){
    let sql = 'DELETE FROM Customer WHERE customerId = ?';

    return new Promise((resolve, reject) => {
        db.all(sql, customerId, (err, rows) => {
            if (err) {
                reject(err);
            } else {
                resolve(rows);
            }
        });
    });
}

